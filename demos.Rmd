--
title: ""
author: "M. S. Legrand"
output:
  html_document:
    includes:
      in_header: svgLogo.svg
    number_sections: no
    theme: cerulean
    toc: true
    toc_depth: 2
  pdf_document:
    toc: true
    toc_depth: 2 
---


This document describes some of the basics of svgR.  This document has been created from an R Markdown document using svgR. 
For more details on using R Markdown see <http://rmarkdown.rstudio.com>. 
For a good starting place on using SVG see <https://github.com/willianjusten/awesome-svg>


<style>
h1 {
   color: darkblue;
   font-size:3.5em;
}
</style>




<style>
#TOC {
  position: fixed;
  left: 0;
  top: 0;
  width: 220px;
  height: 100%;
  overflow:auto;
}
body {
  max-width: 800px;
  margin: auto;
  margin-left:225px;
  line-height: 20px;
}
</style>




```{r, echo=FALSE}
stopifnot(require(svgR, quietly=TRUE))
```
```{r, echo=FALSE}
if(!exists("newId")){
  source('Util.R')
}
```

<hr><br/><br/> 


### Pie Chart

```{r, echo=T, results='asis'}

colors<-c("red","yellow", "lightblue", "lightgreen", "pink","brown", "orange")
labels<-LETTERS
N<-sample(3:7,1) #number of choices (<= number of colors)
rawData<-runif(N,10,30)
center<-c(100,100) #circle center
radius<-40
OD<-1.2 #expand factor
dur<-0.5 #how fast
#
percentages<-rawData/sum(rawData)
angles<-2*pi*cumsum(percentages)
angles<-c(0,angles )
pts<-cbind(cos(angles), sin(angles))*radius
midptAngles<-0.5*(angles[1:N]+angles[2:(N+1)])
textPos<-0.75*radius*cbind(cos(midptAngles),sin(midptAngles))
midpoints<-(OD-1)*radius*cbind(cos(midptAngles),sin(midptAngles))

WH<-c(800,200)
svgR( 
  text('Click on pie chart to activate', xy=c(20,20)),
  g( transform=list(translate=center),
    lapply(1:N, 
      function(i){
        g( id=paste0("RS",i),
          path( id=paste0('id',i),
            d=list(M=c(0,0), L=pts[i,], 
            A=c(radius, radius,0,
            0,1,pts[i+1,]),z=0), 
            fill=colors[i], stroke="black" 
          ),
          text( labels[i],cxy=(textPos[i,]), 
            stroke='black', stroke.width=0.4, 
            fill='white', font.size=12
          ),
          animateMotion( 
            from=c(0,0), to=midpoints[i,],
            begin=paste0("aniOver",i,".begin"), 
            restart="whenNotActive", dur=dur, 
            repeatCount=1, fill="freeze"
          ),
          animateMotion(
            to=c(0,0), from=midpoints[i,],
            begin=paste0("aniOut",i,".begin"),
            restart="whenNotActive", dur=dur, 
            repeatCount=1, fill="freeze"
          )          
        )            
      }                 
    ),
    lapply(1:N, 
      function(i){
        g( id=paste0("MV",i), 
          opacity=0,
          path( id=paste0('id',i),
            d=list(M=c(0,0), L=pts[i,], 
            A=c(radius, radius,0,
            0,1,pts[i+1,]),z=0), 
            fill=colors[i], stroke="black" 
          ),
          animateTransform(id = paste0("aniOut",i), 
            attributeName='transform', type="scale",
            from=c(OD,OD), to=c(1,1),
            begin="mouseout", 
            dur=dur, repeatCount=1, fill="freeze"
          ),           
          animateTransform(id = paste0("aniOver",i),                   
            attributeName='transform', type="scale",
            from=  c(1,1), to  = c(OD,OD), 
            begin="mouseover", #restart="whenNotActive", 
            dur=dur, repeatCount=1, fill="freeze"
          ), 
          onclick=paste("alert('",colors[i],"was chosen')"  )
        )
      }
    )
  )
)
```


### Stroke Width
```{r, echo=T, results='asis'}
#WH<-c(800,200)
h<-50
r<-h/2
P<-2
w<-(2*pi*r)+h
WH<-c(w,h)
dt<-10
N<-100
x<-seq(r-1,2*pi*r+r,length.out = N+1)
y<-r-r*sin( P*(0:(N))*(2*pi)/N )
points<-rbind(x,y)
ceiling(sum(sqrt(diff(x)*diff(x)+diff(y)*diff(y))))->path.len
spath<-structure(lapply(1:N, function(i)c(x[i],y[i])),names=c("M",rep("L",N-1)))

svgR( wh=WH,
  rect(id="greenR", xy=c(-w,0), wh=c(w,h), 
    stroke="red", fill="lightgreen", opacity=.5,
    animate(attributeName="x", values=x-w, 
            begin="0", dur=dt,  repeatCount="indefinite"
    )
  ),
  rect(xy=c(0,0), wh=c(w,h), stroke="red", 
    fill="lightblue", opacity=.5,
    animate(attributeName="y", values=y, begin="0", 
      dur=dt,  repeatCount="indefinite"
    )
  ),
  line(xy1=c(1,h), xy2=c(w+1,h), stroke="black"),
  line(xy1=c(1,h/2), xy2=c(w+1,h/2), stroke="grey"),
  line(xy1=c(1,1), xy2=c(1,h), stroke="black") ,
  g( 
    circle(cxy=c(r,r),r=r, stroke="blue", fill="none"),
    g(
      line(xy1=c(r,r), xy2=c(1,r), stroke="lightblue"),
      circle(cxy=c(r,r), r=2, fill="blue"),
      circle(cxy=c(1,r), r=2, fill="blue"),
      animateTransform(attributeType="xml",
        attributeName="transform", type="rotate",
        from=c(0,r,r),to=c(P*360,r,r),
        dur=dt, repeatCount="indefinite"
      )
    ),
    animateMotion(id="simple.animate", 
      from=c(1,1), to=c(2*pi*r,1), 
      begin="0", dur=dt,  repeatCount="indefinite"
    )
  ),
  path(d=spath,  stroke="red", fill="none", stroke.width=2,
    stroke.dasharray=path.len, stroke.dashoffset=path.len,
    animate(attributeName="stroke.dashoffset", 
      from=path.len, to=0 , dur=dt,repeatCount="indefinite"
    )
  ),
  circle(
    stroke="black", fill="red", r=2, 
    animateMotion(path=spath, begin=0, 
      dur=dt, repeatCount="indefinite"
    )
  )
)
```

### Animated Flower
```{r, echo=T, results='asis'}
s.colors<-c("red","blue","yellow","green")
s.offset<-0.25*c(0,1,3,4)
idr<-paste0("ro",1:4)
vals<-c("#ffff80", "#ff8080", "#ff80ff", "#8080ff", "#80ffff", "#80ff80")
svgR( wh=c(800,600),
  defs( linearGradient(id='rhue', colors=c('red','blue','yellow','green'))),  
  ellipse( cxy=c(290,250), rxy=c(80,80),
    animate( attributeName='fill', dur=5, 
             values=vals, repeatCount='indefinite')
    ),
  g(id='penta',
    g( id='R1', transform=list(translate=c(200, 250)),
      ellipse( cxy=c(0,0), rxy=c(100,30), opacity=0.4, fill="url(#rhue)",
        animateTransform(attributeName="transform", type="rotate", 
          dur="7s", from="0", to="360", repeatCount="indefinite"
        ),
        animate(attributeName="cx", dur=8, values=c(-20, 120, -20), repeatCount="indefinite" ),
        animate(attributeName="ry", dur=3, values=c(10,60,10), repeatCount="indefinite")
      )                  
    ),
    lapply(1:4, function(i) 
      use(xlink.href='#R1', transform=list(rotate=c(i*30,300,250))) 
    )    
  ),
  lapply(1:4, function(i) 
    use(xlink.href='#penta', transform=list(rotate=c(i*72,290,250))) 
  )                           
)
```

### RStudio Logo
```{r, echo=T, results='asis'}

center<-c(200,200)
radius<-120
 
svgR( wh=c("12cm", "12cm"), viewBox=c( c(0,0), c(500,500)),
  defs( 
    radialGradient(id="grad1",
      cxy=c("50%","80%"),
      fxy=c("50%", "100%"),
      colors=c("rgb(255,255,255)", "rgb(0,64,128)"  )
    ),
    linearGradient(id="grad2",
      xy1=c("0%","10%"), xy2=c("0%","80%"), 
      colors=c("rgb(255,255,255)" , "rgb(64,128,196)")
    ),
    filter(id="gaussblur",
      xy=c("-5%","-5%"), wh=c("110%","110%"), #insures +- 1/2 of width
      feGaussianBlur(stdDeviation="1.5", result="blur")    
    )
  ),
  ellipse(cxy=center+c(0,radius), rxy=c(radius, 0.2*radius), 
    fill="grey", filter="url(#gaussblur)"
  ),
  g(      
    circle(id="c1", cxy=center, r=radius, 
      stroke="none", fill = "url(#grad1)" 
    ), 
    ellipse(cxy=center-c(0,radius/2), rxy=c(.6*radius, .5*radius), 
      fill="url(#grad2)",filter="url(#gaussblur)" 
    )          
  ),
  text("R", font.size=144,  font.family = "serif",
  cxy=center, fill="white")
)
```

### A Stenciled Letter R
```{r, echo=T, results='asis'}
#doc<-svgDoc.new(width="12cm", height="12cm", viewBox="0 0 500 300", version=1.1)
center<-c(100,10)
svgR( wh=c("12cm","12cm"), viewBox=c(0,0,500,300),
  defs(
    filter( id='emboss',
      feGaussianBlur(  in1='SourceAlpha', stdDeviation=2, result='blur'),
      feSpecularLighting( in1='blur', surfaceScale=-3, style='lighting-color:white', 
        specularConstant=1, specularExponent=16, result='spec', 
        kernelUnitLength=1, feDistantLight(azimuth=45, elevation=45)
      ),
      feComposite(in1='spec', in2='SourceGraphic', operator='in', result='specOut'),
      feComposite(in1="SourceGraphic", in2="specOut", operator="arithmetic",
                   k1234=c(0,1,1,0), result="embossOut")
    ),
    filter( id="bevel-shadow", xy=c("-50%","-50%"), wh=c("200%","200%"),
      feGaussianBlur(stdDeviation="1", result="blur"),    
      feOffset('in'="blur", dxy=c(1,1), result="blur1"),
      feOffset('in'="blur", dxy=c(0,0), result="blur2"),           
      feComposite('in'="blur2", 'in2'="blur1", operator="arithmetic", 
        k2="1", k3="-1", result="diff1"
      ),
      feFlood(flood.color="back" ),
      feComposite('in2'="diff1", operator="in", result="diff1"),
      feComposite('in'="blur1", 'in2'="blur2", operator="arithmetic",  
        k2="1", k3="-1", result="diff2"
      ),
      feFlood(flood.color="white", flood.opacity="0.5" ),
      feComposite('in2'="diff2", operator="in", result="diff2"),
      feMorphology(operator="erode", radius=2, 'in'="SourceAlpha" ),
      feGaussianBlur(stdDeviation=2, result="blur"),
      feOffset(dxy=c(3,3)),
      feComposite('in2'="SourceAlpha", operator="arithmetic", 
        k2="-1", k3="1", result="shadowDiff"
      ),       
      feFlood(flood.color="black", flood.opacity=".8" ),
      feComposite('in2'="shadowDiff", operator="in", result="shadow"),
      feMerge(
        feMergeNode( 'in'="SourceGraphic"),
        feMergeNode( 'in'="shadow"),
        feMergeNode( 'in'="diff1"),
        feMergeNode( 'in'="diff2")
      )
    )  
  ),
  rect(id="tmp", cxy=center, wh=c(200,150), stroke="black", 
       fill="rgb(128,128,192)", filter="url(#emboss)"
  ),
  text("R",  cxy=center, font.size=144, font.weight="bold",
       stroke="black", fill="rgb(224,224,255)", filter="url(#bevel-shadow)"
  )    
)
```

### Omega on paper
```{r, echo=T, results='asis'}
svgR( wh=c(600,200),
  defs(
    filter( id="roughpaper",
      feTurbulence( in1="SourceGraphic", type="fractalNoise", 
        baseFrequency=0.1, numOctaves=5, result="noise"
      ),
      feDiffuseLighting(in1="noise", lighting.color="khaki",
        surfaceScale=2, result="diffLight",
        feDistantLight(azimuth=45, elevation=35)
      )             
    )           
  ), 
  rect(xy=c(0,0),wh=c(500,200), filter="url(#roughpaper)"),
  text(id="t1", xy=c(20,130), 
    paste("Omega:", mathSymbol("\\Omega")), 
    stroke="none",stroke.width=1, font.size=100, 
    font.weight="bold", fill="brown", opacity=0.4
  )     
)
```

### Omega in Marble
```{r, echo=T, results='asis'}
svgR(wh=c(600,200),
  defs(
    filter( id="marble",
      feTurbulence( in1="SourceGraphic", type="turbulence", 
          baseFrequency=0.05, numOctaves=2, result="marb"
      )
    ),
    clipPath( id="clp1",  text(id="t2", xy=c(0,0), 
      mathSymbol("\\Omega"), stroke="black",
      stroke.width=1, font.size=250, font.weight="bold"
    )     
  )      
), 
  g( transform=list(translate=c(50,200)), 
    use(xlink.href="#t2", stroke="grey",
      fill="lightgrey" , transform=list(scale=c(1,0.4), skewX=-60) 
    ),
    g( transform=list(translate=c(5,-3)),
      use(xlink.href="#t2",fill="grey", stroke="black"),
      rect(xy=-c(0,200),wh=c(800,400), fill="blue",
        filter="url(#marble)", clip.path="url(#clp1)"
      )       
    ),
    use(xlink.href="#t2",fill="white", stroke="black"),
    rect(xy=-c(0,200),wh=c(800,400), 
      fill="white", filter="url(#marble)", clip.path="url(#clp1)"
    ),
    use(xlink.href="#t2", fill="none")
  )
)
```

### Grid Layout
```{r, echo=T, results='asis'}

nx=20; ny=20
WH<-c(450,300)
w<-WH[1]; h<-WH[2]
svgR( wh=WH,
  defs( 
    linearGradient(id="my.grad",xy1=c("0%","0%"), xy2=c("0%","100%"), 
      colors=c( "rgb(196,196,255)", "rgb(10,10,96)" ) 
    ) 
  ), 
  g( id="gridLayout",
    rect(id="rect.my", xy=c(0,0), wh=WH, 
         stroke="black", stroke.width=3, fill="url(#my.grad)" 
    ),
  lapply( seq(1,w, length.out=nx), 
      function(x) line( xy1=c(x,0), xy2=c(x,h), stroke="white", stroke.width=1 ) 
  ),
  lapply( seq(1,h, length.out=ny),
    function(y)  line( xy1=c(0,y), xy2=c(w,y), stroke="white", stroke.width=1 ) 
  )
  )     
) 
```


### Animate Visibility
```{r, echo=T, results='asis'}
makeCircle<-function(i){
  times<-runif(3,0,1)
  circle( cxy=runif(2,1,200), r=runif(1,5,30), visibility="visible",
    fill=paste0("rgb(", paste(sample(40:255,3),collapse=","), ")"),
    set(id=paste0("c2x",i), attributeName="visibility", 
      to="hidden", begin=paste0(times[1],"; c1x",i,".end"),dur=times[2]
    ),          
    set(id=paste0("c1x",i), attributeName="visibility", 
      from="hidden", to="visible", 
      begin=paste0("c2x",i,".end"), dur=times[3] 
    )
  )
}
svgR( 
  lapply(1:20, makeCircle)
)
```


### Animate Pacman
```{r, echo=T, results='asis'}
WH=c(600,200)
cxy<-c(120, 120)
r<-50
dt<-0.5
dt.bite<-0.8*dt
btime<-paste0(dt,";bite.end+",dt)
eye<-list(r=max(1, r*.18), stroke=max(1, r*.14) )    
svgR( wh=WH,
  g( transform=list(translate=cxy-c(r,r) ),
    g(id="balls", 
      lapply(1:6, function(i) 
        circle( cxy=c(40+i*50,0),r=10, stroke="black", fill="red")),
      animateMotion(from=c(0,0), to=c(-50,0), 
        dur=dt+dt.bite, begin=0, repeatDur="indefinite"
      )
    ),
    g(id="pac.man", 
      clipPath( id="pac-clip1",rect(id="r1",xy=-c(r,r), wh=c(2,1)*r) ),
      g( id="pac-g-1",       
        circle(id="c1", 
          cxy=c(0,0), r=r, fill="yellow", 
          clip.path="url(#pac-clip1)", 
          stroke="black", stroke.width=1
        ), #top circle
        line(id="pac-l-1", xy1=c(0,0), xy2=c(r,0), stroke="black", stroke.width=1),
        animateTransform(id="bite",
          attributeName="transform", attributeType="xml", type="rotate", 
          from=c(0,0,0), to=c(-70,0,0),
          begin=btime, dur=dt.bite
        )
      ),
      g( id="pac-g-2", 
        circle(id="c2", 
          cxy=c(0,0), r=r, fill="yellow", 
            transform=list(rotate=c(180,0,0)), "clip-path"="url(#pac-clip1)", 
            stroke="black", stroke.width=1
        ), #, #bot circle
        line(id="pac-l-2", xy1=c(0,0), xy2=c(r,0), stroke="black", stroke.width=1),
          animateTransform(
            attributeName="transform", attributeType="xml", type="rotate", 
            from=c(0,0,0), to=c(70,0,0),
            begin=btime, dur=dt.bite)
       ),       
       circle(id="eye", cxy=-r*c(.1,.5), r=eye$r, 
          fill="#000", stroke="white", stroke.width=eye$stroke)                        
     ) 
  )
)
```

###Yin Yang
```{r, echo=T, results='asis'}
  svgR( wh=c(200,200),
    clipPath(id="clipper", rect(xy=c(40,100),wh=c(120,60) )),
    circle(cxy=c(100, 100), r=60, fill="red" ), 
    circle( cxy=c(100, 100), r=60, fill="black", clip.path="url(#clipper)" ) , 
    circle(cxy=c(100+30,100),r=30, fill="red"),
    circle(cxy=c(100-30,100),r=30, fill="black")
  )
```


### R logo
```{r, echo=T, results='asis'}
  center<-c(200,10)
  cp<-function(x,y){ paste(c(x,y),"%", sep="")}
  svgR( wh=c("12cm","12cm"), viewBox=c(c(0,0), c(500,300)),
    defs(
      filter(
        id="distLight", 
        filterUnits="boundingbox", 
        xy=c("-10%","-10%"), 
        wh=c("120%","120%"),
        feGaussianBlur( in1="SourceGraphic", stdDeviation=3, result="blur" ),
        feSpecularLighting( 
          in1="blur", 
          surfaceScale=30, 
          specularConstant=0.75,                
          specularComponent=20, 
          lighting.color="rgb(200,200,255)", 
          result="specOut",
          feDistantLight(azimuth=180+45, elevation=45)
        ),
        feComposite( in1="specOut", in2="SourceAlpha", operator="in", result="specOut2"),
        feComposite( in1="SourceGraphic", in2="specOut2", operator="arithmetic", 
                     k1=0, k2=1, k3=1, k4=0)     
      ),
      filter(
        id="distLight2", 
        filterUnits="boundingbox", 
        xy=c("10%","10%"), 
        wh=c("80%","80%"),
        feGaussianBlur( in1="SourceGraphic", stdDeviation=3, result="blur" ),
        feSpecularLighting( 
          in1="blur", 
          surfaceScale=30, 
          specularConstant=0.75,                
          specularComponent=20, 
          lighting.color="rgb(200,200,255)", 
          result="specOut",
          feDistantLight(azimuth=45, elevation=45)
        ),
        feComposite( in1="specOut", in2="SourceAlpha", operator="in", result="specOut2"),
        feComposite( in1="SourceGraphic", in2="specOut2", operator="arithmetic", 
                     k1=0, k2=1, k3=1, k4=0)     
      ),
      filter(
        id="distLight3", 
        filterUnits="boundingbox", 
        xy=c("-10%","-10%"), 
        wh=c("120%","120%"),
        feGaussianBlur( in1="SourceGraphic", stdDeviation=3, result="blur" ),
        feSpecularLighting( 
          in1="blur", 
          surfaceScale=30, 
          specularConstant=0.75,                
          specularComponent=20, 
          lighting.color="rgb(200,200,255)", 
          result="specOut",
          feDistantLight(azimuth=45, elevation=45)
        ),
        feComposite( in1="specOut", in2="SourceAlpha", operator="in", result="specOut2"),
        feComposite( in1="SourceGraphic", in2="specOut2", operator="arithmetic", 
                     k1=0, k2=1, k3=1, k4=0)     
      ),    
      filter(id="gaussblur",
             xy=c("-5%","-5%"), wh=c("110%","110%"), #insures +- 1/2 of width
             feGaussianBlur(stdDeviation="1.5", result="blur")    
      )
    ),   
    ellipse( cxy=center-c(50,20), rxy=c(120,75), fill="dark-grey" , filter="url(#distLight)"
    ),
    g(    ellipse( cxy=center-c(44,22), rxy=c(110,65), fill="white" 
    ),   
    ellipse( cxy=center-c(40,20), rxy=c(110,65), #fill="red" , 
             stroke.width=3,
             filter="url(#distLight)"
    ),
    ellipse( cxy=center-c(40,19), rxy=c(110,65), #fill="red" , 
             stroke.width=3,
             filter="url(#distLight3)"
    ),
    ellipse( cxy=center-c(35,21), rxy=c(100,55), fill="white", stroke.width=1,
             stroke="white"
    ),
    ellipse( cxy=center-c(30,20), rxy=c(90,53), fill="black", stroke.width=5,
             stroke="black", filter="url(#gaussblur)"
    ),
    filter="url(#gaussblur)" 
    
    ),
    ellipse( cxy=center-c(20,18), rxy=c(80,50), fill="white"
    ),
    text("R",  cxy=center, font.size=144, stroke="black", 
         stroke.width=20, 
         filter="url(#distLight)"),
    text("R",  cxy=center, font.size=144, stroke="black", 
         stroke.width=2, 
         fill="rgb(128,128,193)" ,
         filter="url(#distLight2)"
    )
  )
```

### Google logo
```{r, echo=T, results='asis'}
  center<-c(200,200)
  radius<-120
  WH=c("12cm","12cm")
  viewBox=c(c(0,0),c(500,500))
  svgR( wh=WH, viewBox=viewBox,
    defs(
      filter(       id='embossWithShadow',
                    feGaussianBlur(  in1='SourceAlpha', stdDeviation=2, result='blur'),
                    feGaussianBlur(  in1='blur', dx="4", dy="4", result="shadowOut"),
                    feSpecularLighting(  in1='blur', surfaceScale=-3, style='lighting-color:white', specularConstant=1, 
                                         specularExponent=16, result='spec', kernelUnitLength=1,
                                         feDistantLight(azimuth=45, elevation=45)
                    ),
                    feComposite(  in1='spec', in2='SourceGraphic', operator='in', result='specOut'  ),
                    feComposite(  in1="SourceGraphic", in2="specOut", operator="arithmetic",
                                  k1=0, k2=1, k3=1, k4=0, result="embossOut"),
                    feMerge(feMergeNode(in1="shadowOut"), feMergeNode(in1="embossOut"))
      ),
      text( id="google",  x=20, y=100, font.size=72, font.weight='bold', 
            font.family = "Verdan",  
            tspan( 'G', fill='blue',   stroke="black" , rotate=3),
            tspan( 'o', fill='red',    stroke="black",  rotate=-20),
            tspan( 'o', fill='yellow', stroke="black", rotate=5),
            tspan( 'g', fill='blue',   stroke="black", rotate=-35),
            tspan( 'l', fill='green',  stroke="black", rotate=30 ),
            tspan( 'e', fill='red',    stroke="black", rotate=20)
      )
    ),
    g( 
      use( "xlink:href"="#google", filter='url(#embossWithShadow)') #now emboss the letters
    )
  )
```

### Ubuntu logo
```{r, echo=T, results='asis'}
cXY<-c(0,0) # center
  S<-100 #seperation between centers
  
  R<-c(0.4,0.95)*S # arc radii: require 0< R[1]< R[2]
  r<-S * c(0.24,0.4) # require: 1-R[1]> r[2] >1-R[2] ( or R[1]<1-r[2]<R[2] ); 0<r[1]<r[2]
  Gap<-.1*S #space between arcs
  theta<-asin(Gap/R)
  XY1<-t(diag(R) %*% cbind(cos(theta),sin(theta))) + cXY #rows are the starting points of arc
  XY2<-t(diag(R) %*% cbind(cos(2*pi/3-theta),sin(2*pi/3-theta))) + cXY #rows are ending points of arc  
  d.eta= acos( (S^2 + r[2]^2 - (R[2]^2))/(2*S*r[2]) ) 
  eta<- -2*pi/3 + d.eta*c(-1,1)
  cxy<-cXY + S*c(cos(pi/3),sin(pi/3)) #center of satellite
  xy1<-cxy + t(r[2]*cbind(cos(eta), sin(eta)))
  
  
  
WH=c("12cm", "12cm")
svgR( wh=WH, viewBox="0 0 500 500",
  defs(
    filter(       id='filterShadow', height='150%',
                  feGaussianBlur( in1='SourceAlpha', stdDeviation=6, result='image1'  ),
                  feOffset( in1='image1', result='image2', dx=5, dy=5 ),
                  feComposite(in1='SourceGraphic', in2='image2', operator='over'  )
    ),
    filter(       id='emboss',
                  feGaussianBlur(  in1='SourceAlpha', stdDeviation=2, result='blur'      ),
                  feSpecularLighting(  in1='blur', surfaceScale=-3, style='lighting-color:white', specularConstant=1, 
                                       specularExponent=16, result='spec', kernelUnitLength=1,
                                       feDistantLight(azimuth=45, elevation=45)
                  ),
                  feComposite(  in1='spec', in2='SourceGraphic', operator='in', result='specOut'  )
    ),
    path( id="arc", d=list(M=XY1[,1], 
                           L=XY1[,2], 
                           A=c( c(R[2],R[2]), 0,  0, 1 , xy1[,2] ) , 
                           A=c( c(r[2],r[2]), 0,  0, 0 , xy1[,1] ) , 
                           A=c( c(R[2],R[2]), 0,  0, 1 , XY2[,2] ) ,                  
                           L=XY2[,1], 
                           A=c( c(R[1],R[1]), 0,  0, 0 , XY1[,1] ) ,
                           Z=0),
          stroke="black", stroke.width="3" ),
    circle(id="satellite", cxy=cxy, r=r[1], stroke="black"),     
    g( id='ubuntu',
       g(  transform=list(translate=c(200,200) ,rotate=0) , 
           use( "xlink:href"="#arc", fill="red"),
           use( "xlink:href"="#satellite", fill="yellow")
       ),
       g(  transform=list(translate=c(200,200) ,rotate=120) , 
           use( "xlink:href"="#arc", fill="yellow"),
           use( "xlink:href"="#satellite", fill="orange")
       ),
       g(  transform=list(translate=c(200,200) ,rotate=240) , 
           use( "xlink:href"="#arc", fill="orange"),
           use( "xlink:href"="#satellite", fill="red")
       )       
    )
  ), 
  use( "xlink:href"="#ubuntu",  filter='url(#filterShadow)'),
  use( "xlink:href"="#ubuntu",  filter='url(#emboss)')
)
```


### Beveled Integral
```{r, echo=T, results='asis'}
center<-c(145,10)
wh<-c(290,250) #dimensions of rectangle
integral<-mathSymbol("\\int")
WH=c("12cm","12cm")
viewBox=c(c(0,0),c(600,300))
svgR( wh=WH, viewBox=viewBox,
  defs(
    filter( id='emboss',
      feGaussianBlur(in1='SourceAlpha', stdDeviation=2, result='blur'),
      feSpecularLighting(in1='blur', surfaceScale=-3, style='lighting-color:white', 
        specularConstant=1, specularExponent=16, result='spec', kernelUnitLength=1,
        feDistantLight(azimuth=45, elevation=45)
      ),
      feComposite(in1='spec', in2='SourceGraphic', operator='in', result='specOut')
    ),
    filter( id="bevel-shadow", xy=c("-50%","-50%"), wh=c("200%","200%"),
      feGaussianBlur(stdDeviation="1", result="blur"),    
      feOffset('in'="blur", dxy=c(1,1), result="blur1"),
      feOffset('in'="blur", dx=c(0,0), result="blur2"),           
      feComposite('in'="blur2", 'in2'="blur1", operator="arithmetic", 
        k2="1", k3="-1", result="diff1"
      ),
      feFlood(flood.color="back" ),
      feComposite('in2'="diff1", operator="in", result="diff1"),
      feComposite('in'="blur1", 'in2'="blur2", operator="arithmetic",  
        k2="1", k3="-1", result="diff2"
      ),
      feFlood(flood.color="white", flood.opacity="0.5" ),
      feComposite('in2'="diff2", operator="in", result="diff2"),
      feMorphology(operator="erode", radius=2, 'in'="SourceAlpha"),
      feGaussianBlur(stdDeviation=2, result="blur"),
      feOffset(dxy=c(3,3)),
      feComposite('in2'="SourceAlpha", operator="arithmetic", 
        k2="-1", k3="1", result="shadowDiff" 
      ),       
      feFlood(flood.color="black", flood.opacity=".8" ),
      feComposite('in2'="shadowDiff", operator="in", result="shadow"),
      feMerge(
        feMergeNode( 'in'="SourceGraphic"),
        feMergeNode( 'in'="shadow"),
        feMergeNode( 'in'="diff1"),
        feMergeNode( 'in'="diff2")
      )
    )  
  ),
  rect(id="tmp", cxy=center, wh=wh, stroke="black", fill="#8B4513"),
  rect(id="tmp", cxy=center, wh=wh, stroke="black", fill="#8B4513", filter="url(#emboss)"),
  text(cxy=center, font.size=80, font.weight="bold", 
    font.family="Arial",alignment.baseline='mathematical',
    stroke="black", fill="rgb(224,224,255)", filter="url(#bevel-shadow)",         
    tspan( font.size=96, integral),  
    tspan(" x"),
    tspan("2", baseline.shift="super",  font.size=40),
    tspan(" dx"),          
    cxy=center, font.size=80, font.weight="bold", font.family="Arial",
    stroke="black", fill="rgb(224,224,255)", filter="url(#bevel-shadow)"
  )
)
```
### Animated Gears
```{r, echo=T, results='asis'}
gear.new<-function(N , gear=NULL, theta=NULL, 
                     r=NULL , cxy=c(0,0), 
                     delta=10, phase=0,
                     angularVelocity=0
  )
  {
    if(! is.null(gear)) {
      angularVelocity<- - gear$N*gear$angularVelocity/N
      delta<-gear$delta
      n_theta<- floor((theta - gear$phase)/(pi/gear$N))
      theta_prime<-(n_theta+1) * (pi/gear$N)
      phase<-gear$phase + theta_prime + pi
      if(n_theta%%2==1){ #new=peg, gear=gap
        phase<-phase + (pi/N)
      }
      r<-N*gear$r/gear$N
      cxy<-gear$cxy + 
        (r+delta+gear$r)*c( cos(theta_prime+gear$phase), 
                            - sin(theta_prime+gear$phase))  
    }
    R<-delta+r
    phi<-2*pi/(3*N)
    Phi<-phi*r/R
    eta<-phi - Phi/2 
    radii<-rep(c(r,r,R,R),N)
    angles<-rep(c(phi,eta,Phi,eta),N)
    angles<-angles[-length(angles)]
    angles<-c(phase-phi/2,angles)
    angles<-cumsum(angles)
    x<-radii*cos(angles)+cxy[1]
    y<- -radii*sin(angles)+cxy[2]
    
    tmp1<-rbind(c("M",rep("L",length(x)-1)), x, y)
    tmp2<-apply(tmp1, 2,function(x)paste(x,collapse=" "))
    tmp5<-c(tmp2," Z")
    pathD<-paste(tmp5, collapse=" ")     
    
    structure(list(r=r, N=N, phase=phase, cxy=cxy,
                   delta=delta, theta=theta, 
                   angularVelocity=angularVelocity, 
                   pathD=pathD),
              class="gear")
  } 
  
  
  g1<-gear.new(16,r=40, cxy=c(100,100), 
               angularVelocity=0.25, phase=0)
  g2<-gear.new(18,gear=g1, theta=0)
  g3<-gear.new(28,gear=g1, theta=-pi/2)
  g4<-gear.new(8, gear=g2, theta=-pi/3)
  
  decorate<-function(gear, N, theta0= 0, #pi/3, 
                     thickness=8, r=2*gear$delta, 
                     M=N+1,
                     R=gear$r - gear$delta)
  {
    dtheta<-(2*pi/N) 
    eta     = thickness / (2*r)  
    thetas   = seq(theta0,2*pi+theta0,  length.out=M)
    oneSeg<-function(theta){
      phi1<- theta   + thickness/(2*r) 
      Phi1<- theta   + thickness/(2*R) 
      phi2<- theta  + dtheta  - thickness/(2*r) 
      Phi2<- theta  + dtheta  - thickness/(2*R) 
      pt1<-gear$cxy + R*c(cos(Phi1),sin(Phi1))
      pt2<-gear$cxy + R*c(cos(Phi2),sin(Phi2))
      pt3<-gear$cxy + r*c(cos(phi2),sin(phi2))
      pt4<-gear$cxy + r*c(cos(phi1),sin(phi1))
      decor<-list(
        M=pt1,
        A=c(R,R,0,0,1, pt2),
        L=pt3,
        A=c(r,r,0,0,0, pt4),
        Z=1
      )    
    }
    tmp<-lapply(thetas, oneSeg)
  }
  
  g3Decor<-decorate(gear=g3, N=3, thickness=15)
  g2Decor<-decorate(gear=g2, N=5)
  
  wheelColor<-"rgb(168,128,64)"
  WH=c(300,400)
  svgR(wh=WH,
    g( id="gear1",
       path( d=g1$pathD, fill=wheelColor,
             stroke="black",
             stroke.width="2"
       ),    
       circle( cxy=g1$cxy, r=g1$r-g1$delta,
               fill="rgb(168,128,64)", stroke="rgb(128,92,48)",
               stroke.width=5),
       animateTransform(attributeType="xml",
                        attributeName="transform",
                        type="rotate",
                        from=c(0, g1$cxy),
                        to=c(sign(g1$angularVelocity)*360, g1$cxy),
                        dur=abs(1/g1$angularVelocity),
                        repeatCount="indefinite")     
    ),
    g( id="gear2",
       path( d=g2$pathD, fill="rgb(168,128,64)",
             stroke="black",
             stroke.width="2"
       ), 
       lapply(g2Decor, function(gd){
         path(d=gd, stroke="black", fill="white")
       }), 
       circle( cxy=g2$cxy, r=(g2$r + g2$delta)/4,
               fill="rgb(168,128,64)", stroke="black"),
       animateTransform(attributeType="xml",
                        attributeName="transform",
                        type="rotate",
                        from=c(0, g2$cxy),
                        to=c(sign(g2$angularVelocity)*360, g2$cxy),
                        dur=abs(1/g2$angularVelocity),
                        repeatCount="indefinite")     
    ),
    g(id="gear3",
      path( d=g3$pathD, fill="rgb(168,128,64)",
            stroke="black",
            stroke.width="2"
      ),
      lapply(g3Decor, function(gd){
        path(d=gd, stroke="black", fill="white")
      }),
      animateTransform(attributeType="xml",
                       attributeName="transform",
                       type="rotate",
                       from=c(0, g3$cxy),
                       to=c(sign(g3$angularVelocity)*360, g3$cxy),
                       dur=abs(1/g3$angularVelocity),
                       repeatCount="indefinite")
    ),
    g(id="gear4",
      path( d=g4$pathD, fill="rgb(168,128,64)",
            stroke="black",
            stroke.width="2"
      ),
      animateTransform(attributeType="xml",
                       attributeName="transform",
                       type="rotate",
                       from=c(0, g4$cxy),
                       to=c(sign(g4$angularVelocity)*360, g4$cxy),
                       dur=abs(1/g4$angularVelocity),
                       repeatCount="indefinite")   
    )
    
  )
  
```

### Animated Directed Graph
```{r, echo=T, results='asis'}
 N<-6
  top<-50
  bottom<-150
  xs<-(1:N)*60  
  colors<-c('lightgreen','orange','khaki','lightblue','pink','yellow', 'red')
  svgR(wh=c(600,200),
    lapply(1:(N-1), function(i){
      line(xy1=c(xs[i],top), xy2=c(xs[i],bottom), stroke="blue",
           stroke.width=5,
           stroke.dasharray=8, 
           stroke.dashoffset=16,
           animate(attributeName="stroke.dashoffset", from=16, to=0 , 
                   dur=0.5, repeatCount="indefinite")         
      )      
    }),
    lapply(1:(N-1), function(i){
      line(xy1=c(xs[i],top), xy2=c(xs[i+1],bottom), stroke="lightblue",
           stroke.width=5,
           stroke.dasharray=8, 
           stroke.dashoffset=16,
           animate(attributeName="stroke.dashoffset", from=16, to=0 , 
                   dur=0.5, repeatCount="indefinite")         
      )      
    }),
    lapply(1:(N-1), function(i){
      line(xy1=c(xs[i],bottom), xy2=c(xs[i+1],top), stroke="lightgreen",
           stroke.width=8,
           stroke.dasharray=5, 
           stroke.dashoffset=10,
           animate(attributeName="stroke.dashoffset", from=8, to=0 , 
                   dur=0.15, repeatCount="indefinite")         
      )      
    }),    
    lapply(1:(N), function(i){
      circle(id=paste0("circleT-",i), #opacity=0.5,
             cxy=c(xs[i], top), r=10, fill=colors[i+1], 
             stroke="black", stroke.width=4)}
    ),
    lapply(1:(N), function(i){
      circle(id=paste0("circleB-",i), #opacity=0.5,
             cxy=c(xs[i], bottom), r=10, fill=colors[i], 
             stroke="black", stroke.width=4)}
    )
  )  
```

### Pythagorus

Todo: rewrite this 

```{r, echo=T, results='asis' }
  colors<-c("red","blue", "green", "orange")
  A=80
  B=60
  triPts<-matrix(c(c(0,0),c(A,0),c(0,-B),c(0,0)),2,4)
  trianglePts<-list(
    lower= triPts,
    upper=matrix(c(A,-B),2,4)-triPts
  )
  center<-c(150,150) # center
  triangleID<-paste0("triangle-",1:4)
  dur<-0.5
  
  addTriangle<-function(tri.id, tri.pts, opacity=1, fillColor="white"){
    g(  id=tri.id, opacity=opacity,
        lapply(1:3, 
               function(i){               
                 line(id=paste0(tri.id,"-",i), 
                      opacity=1,  stroke.width=2, 
                      stroke=colors[i],
                      xy1=tri.pts[,i], 
                      xy2=tri.pts[,i+1])           
               }                 
        ),
        polygon(points=tri.pts[,1:4], fill=fillColor, stroke="black", opacity=1)
    )      
  }
  
 
  

  story.new<-function(adoc, dt=2){
    doc=adoc
    delta=dt  
    indx<-0
    function(code){
      fnsList<-list(
        step=function(){
          indx<<-indx+1
        },
        btime=function(){
          indx*delta
        },
        displayText=function(txt, color="black", freeze=FALSE){
          txtId=paste0("txt-",indx )  
          doc[["textArea"]]( text(id=txtId, xy=c(0,0), opacity=0,           
                                  stroke=color, font.size=12,
                                  lapply(txt, function(tx){
                                    if(grepl("^\\^",tx)){
                                      tx<-gsub("^\\^","",tx)
                                      tspan(y=-6, tx, font.size=6)
                                    } else {
                                      tspan(y=0, tx)
                                    }}),
                                  if(!freeze){
                                    set(attributeName='opacity', to=1, begin=btime(), dur=delta)
                                  }  else {
                                    set(attributeName='opacity', to=1, begin=btime())
                                  }
          ))
        },
        wideStroke=function(id){
          doc[[id]](
            set(attributeName="stroke-width", attributeType="CSS", to=5, begin=btime(), dur=delta)
          )
        },
        setOpacity=function(id, value){
          doc[[id]](
            set(attributeName="opacity", attributeType="CSS", to=value, begin=btime(), dur=delta, fill="freeze")
          )  
        },
        moveTo=function(id, from, to){
          doc[[id]](
            animateMotion( from=from, to=to , begin=btime(), dur=delta, fill="freeze")
          )
        },
        rotate=function(id, angles, about=c(0,0)){
          doc[[id]](
            animateTransform( 
              attributeName="transform",
              type="rotate",
              from=c(angles[1], about ),
              to=c(angles[2], about),             
              begin=btime(), 
              dur=delta, 
              fill="freeze"
            ))
        },
        setFill=function(id, value){
          doc[[id]](set(attributeName="fill", attributeType="CSS", to=value, begin=btime() )
          )  
        }
      )
      
      eval(substitute(code), list2env(fnsList, parent.frame() ))
      tmp<-as.character(doc)
      tmp
    }
  }
  
   doc<-svgR(wh=c(400,600),
    g(id = "textArea",  transform=list(translate=(center*c(0.8,0.3)))),
    g(id = "graphArea", transform=list(translate=center),
      rect(id="ASquared", wh=c(A,A), xy=-c(0,A), stroke="black", 
           fill="pink",  opacity=0),
      rect(id="BSquared", wh=c(B,B), xy=-c(B,0), stroke="black", 
           fill="lightgreen", opacity=0),
      rect(id="CSquared", wh=c(A+B,A+B), xy=-c(B,A), stroke="black", 
           stroke.width=3, fill=colors[4], opacity=0),  
      g(id="A", 
        addTriangle("triangle-I", trianglePts$lower, opacity=1),
        addTriangle("triangle-II", trianglePts$upper, opacity=0)
      ),
      g(id="B", opacity=0,
        addTriangle("triangle-III", trianglePts$lower, opacity=1),
        addTriangle("triangle-IV", trianglePts$upper, opacity=1)
      )
    )
  )
  
  story<-story.new(doc)
  story({
    displayText('A right triangle')
    step()
    displayText('Side A', color=colors[1])
    wideStroke("triangle-I-1")
    
    step()
    displayText('Side B', color=colors[3])
    wideStroke("triangle-I-3")
    
    step()
    displayText('Side C', color=colors[2])
    wideStroke("triangle-I-2")
    
    step()
    displayText('An A by B rectangle ')
    setOpacity("triangle-II", 1)
    
    step()
    displayText('Copy')
    setOpacity("B", .5)
    moveTo("B", from=c(0,0), to=c(0,B))
    
    step()
    displayText('Rotate')
    setOpacity("B", 1)
    rotate("A", angles=c(0,-90), about=c(0,0))
    
    step()
    displayText(c('A ', '^2') , 'red')
    setOpacity("ASquared", 1)
    
    step()
    displayText(c('B','^2'), 'green')
    setOpacity("BSquared", 1)
    
    step()
    displayText(c('A', '^2',' + ','B', '^2'), 'brown')
    setOpacity("CSquared", 1)
    
    step()
    displayText(c('A', '^2',' + ','B', '^2'), 'brown')
    moveTo("triangle-III", from=c(0,0), to=c(-B,0))
    
    step()
    displayText(c('A', '^2',' + ','B', '^2'), 'brown')
    moveTo("triangle-IV", from=c(0,0), to=c(0,-A))
    
    step()
    displayText(c('A', '^2',' + ','B', '^2'), 'brown')
    moveTo("triangle-I", from=c(0,0), to=c(-B,A))
    
    step()
    displayText(c('A', '^2',' + ','B', '^2',' = ','C','^2'), 'blue', freeze=TRUE)
    setFill("CSquared", "lightblue" )  
  }
  )->tale
  
doc
  ```

  
### Sin($\alpha+\beta$)

```{r echo=TRUE, results='asis'}
begTxt<-c(20,30)
  begGrph<-c(20,45)
  center<-begGrph+c(60,70)
  alpha<-0.1*pi
  beta<-0.3*pi
  
  # point data
  angleColor<-c("pink","lightblue")
  sideID<-c('cos', 'hyp', 'sin')
  colors<-c(hyp="red",sin="blue", cos="green", "purple")
     
  #points to be used for triangles and arcs
  #origin is upper left
  alphaPts1<- matrix(c(c(0,0),c(cos(alpha),0), c(0,sin(alpha)), c(0,0)),2,4)
  alphaPts0<- matrix(c(cos(alpha),sin(alpha)),2,4)-alphaPts1
  betaPts1<-  matrix(c(c(0,0),c(cos(beta),0), c(0,-sin(beta)), c(0,0)),2,4)
  betaPts0<-  matrix(c(cos(beta),sin(alpha)),2,4)-betaPts1
  betaPts1<-  matrix(c(0,sin(alpha)+sin(beta)),2,4)+betaPts1
  
  # points for second backgroud
  pathOuter2<-list( 
    M=c(0,sin(alpha)),  
    L=c(cos(alpha),0),
    L=c(cos(alpha)+cos(beta), sin(beta)),
    L=c(cos(beta),sin(beta)+sin(alpha)),
    Z=0
  ) 
  
  ptsSAB1<- c(cos(alpha),0) 
  ptsSAB2<- c(0,sin(alpha)) + cos(alpha+beta)*c(cos(beta),sin(beta))
  ptsS3<-matrix(c(ptsSAB2,  c(0,sin(alpha)), c(cos(alpha),0), ptsSAB2),2,4)
  ptsS4<-matrix(
           c(ptsSAB2,  
           c(cos(beta),sin(alpha)+sin(beta)), 
           c(cos(alpha)+cos(beta), sin(beta)), 
           c(cos(alpha),0), 
           ptsSAB2), 
           2,5)

  # scales the points, should replace this
  scalePts<-function(x, f=120){
    if(inherits(x, "list")){
      x<-lapply(x, function(v)v*f)
    } else {
      x<-x*f
    }      
  }

  # builds arc for angle given pts of triangle
  pts2Arc<-function(pts, sweep, sf=30){
    norm<-function(v) sqrt(v%*%v)
    normalize<-function(v){ v/norm(v) }
    vn<-function(v1,v2,sf){ v1+sf*normalize(v2-v1) }
    vn1<-vn(pts[,2],pts[,3],sf)
    vn2<-vn(pts[,2],pts[,1],sf)
    r<-norm(vn2) #norm(vn2)/1000
    list( M=pts[,2], L=vn1, A=c(r,r,0,0,1-sweep,vn2), Z=0)
  }
  
  # builds tringale from given points
  addTriangle<-function(tri.id, tri.pts, sweep,  visibility='hidden'){
    tri.pts<-scalePts(tri.pts)
    g(  id=tri.id, visibility=visibility, fill="white",
        lapply(1:3, # the sides
               function(i){   #1=hyp, 2=sin, 3=cos            
                 line(id=paste0(tri.id,"-",sideID[i]), 
                      stroke.width=2, 
                      stroke=colors[[ sideID[i] ]],
                      xy1=tri.pts[,i], 
                      xy2=tri.pts[,i+1])           
               }                 
        ),
        polygon(id=paste0(tri.id,"-interior"),
              points=tri.pts[,1:4],  stroke="black"),
        path( id=paste0(tri.id,"-angle"),
              d=pts2Arc(tri.pts, sweep),
              fill=angleColor[1+sweep], 
              stroke="black" 
        )        
    )      
  }
  
  # Here we declare all objects to be animated
  doc<-svgR(wh=c(400,600),
    g(id = "textArea1",  transform=list(translate=begTxt)),
    g(id = "textArea2",  transform=list(translate=begTxt+c(0,15))),
    g(id = "textArea3",  transform=list(translate=begTxt+c(0,30))),
    g(id = "graphArea",  transform=list(translate=c(160,60)),
      g(id='graphAreaR',
        rect(id="Outer", 
             xy=scalePts(c(0,0)), 
             wh=scalePts(c(cos(alpha)+cos(beta), sin(alpha)+sin(beta))) ,
             stroke="black", fill="khaki", visibility='hidden'),
        rect(id="sinacosb", 
             wh=scalePts(c(cos(beta),sin(alpha))), 
             xy=scalePts(c(cos(alpha),0)), stroke="black", 
             fill="pink", visibility='hidden'),
        rect(id="cosasinb", wh=scalePts(c(cos(alpha),sin(beta))), 
             xy=scalePts(c(0,sin(alpha))), stroke="black", 
             fill="lightblue",  visibility='hidden'),
        path(id='Outer2', d=scalePts(pathOuter2), visibility='hidden',
             stroke='red', stroke.width=2,
             fill='khaki'
        ),
        g(id='angles', visibility='hidden',
          path( id=paste0('alpha','-angle'),
                d=pts2Arc(scalePts(alphaPts0), 0),
                fill=angleColor[1], 
                opacity=0.2,
                stroke="black" 
          ),        
          path( id=paste0('beta','-angle'),
                d=pts2Arc(scalePts(betaPts0), 1),
                fill=angleColor[2], 
                opacity=0.2,
                stroke="black" 
          ) 
        ),
        g(id="A", 
          addTriangle("triangle-I",  alphaPts0, sweep=0, visibility='visible'),
          addTriangle("triangle-II", alphaPts1, sweep=0, visibility ='hidden')
        ),
        g(id="B", opacity=1,
          addTriangle("triangle-III", betaPts0, sweep=1,  visibility='hidden'),
          addTriangle("triangle-IV",  betaPts1, sweep=1, visibility='hidden')
        ),
        g(id='Outer3-2', visibility='hidden',
          polygon(id='Outer3-2-Poly',  
                  points=scalePts(ptsS4)[,1:4],
                  stroke='red', stroke.width=2,
                  fill='khaki'
          ),
          line(id='Outer3-2-upperLeg',
               xy1=scalePts(ptsS4[,3]),
               xy2=scalePts(ptsS4[,4]),
               stroke.width=2,
               stroke='red'
          )
        ),
        addTriangle("triangle-V",  matrix(ptsS3,2,4), sweep=0, visibility='hidden'),
        line(id='sinAplusB', visibility='hidden',
             xy1=scalePts(ptsSAB1),
             xy2=scalePts(ptsSAB2),
             stoke.width=3,
             stroke='purple')
      )     
    )
  )
  
  # here we define our animation routines
  story.new<-function(adoc, dt=2){
    doc=adoc
    delta=dt  
    indx<-0
    textAreaIds<-list(textArea1=NULL,textArea2=NULL,textArea3=NULL)
    function(code){
      fnsList<-list(
        step=function(inc=1){
          indx<<-indx+inc
        },
        
        btime=function(){
          indx*delta
        },
        
        displayText=function(txt, color="black"){ 
          if(!is.null(textAreaIds[[textArea]])){
            tid<-textAreaIds[[textArea]]
            doc[[tid]](
              set(attributeName="visibility", to='hidden', 
                  begin=btime(), fill="freeze")
            )
          }
          txtId=paste0("txt-",indx )  
          doc[[textArea]]( 
            text(id=txtId, xy=c(0,0), visibility='hidden',           
                 stroke=color, font.size=12,
                 lapply(txt, function(tx){
                   if(grepl("^\\\\",tx)){
                     tspan(mathSymbol(tx))
                   } else {
                     tspan(tx)
                   }}),
                 set(attributeName="visibility", to="visible", begin=btime())
            ))
          textAreaIds[[textArea]]<<-txtId
          txtId
        },
        
        moveTo=function(id, from, to){
          doc[[id]](
            animateMotion( from=from, to=to , begin=btime(), dur=delta, fill="freeze")
          )
        },
        
        rotate=function(id, angles, about=c(0,0)){
          doc[[id]](
            animateTransform( 
              attributeName="transform",
              type="rotate",
              from=c(angles[1], about ),
              to=c(angles[2], about),             
              begin=btime(), 
              dur=delta, 
              fill="freeze"
            ))
        },
        
        setFill=function(id, value, dur=delta){
          doc[[id]](set(attributeName="fill", attributeType="CSS", to=value, begin=btime() , dur=dur)
          )  
        },
        
        setStrokeDecoration=function(id, dur=delta){
          doc[[id]](
            set(attributeName="stroke-width", attributeType="CSS", to=5, 
              begin=btime(), dur=dur),             
            set(attributeName="stroke-dasharray", attributeType="CSS", to=5, 
              begin=btime(), dur=dur)
          )
        },
        
        setStroke=function(id, value, dur=delta){
          doc[[id]](
            set(attributeName="stroke", to=value, begin=btime(), dur=dur )
          )  
        },
        
        setVisibilty=function(id, value, dur=delta){
          doc[[id]](
              set(attributeName="visibility", to=value, begin=btime(), dur=dur )
          )  
        },
        
        setOpacity=function(id, value, dur=delta){
          doc[[id]](
              set(attributeName="opacity", attributeType="CSS", to=value, begin=btime(), dur=dur)             
          )
        }
      )      
      eval(substitute(code), list2env(fnsList, parent.frame() ))
      tmp<-as.character(doc)
      tmp
    }
  }
  
  story<-story.new(doc)
    
  # here we define our story
  story({
    textArea<-'textArea1'
    displayText('A right triangle')
    step()
    
    displayText(c('Angle ', '\\alpha' ), color='red')
    setFill('triangle-I-angle','red')
    step()
    
    displayText('Length=1', color=colors[1])
    setStrokeDecoration('triangle-I-hyp')
    step()
    
    displayText(c('sin( ','\\alpha',' )'),    color='blue')
    setStrokeDecoration('triangle-I-sin')
    step()
    
    displayText(c('cos( ', '\\alpha',' )'),color='green')
    setStrokeDecoration('triangle-I-cos')
    step()
    
    displayText('A second right triangle')
    setVisibilty('triangle-III','visible','indefinite')
    step()
    
    displayText(c('Angle ', '\\beta'), color='blue')
    setFill('triangle-III-angle','blue')
    step()
    
    displayText('Length=1', color=colors[1])
    setStrokeDecoration('triangle-III-hyp')
    step()
    
    displayText(c('sin( ', '\\beta' ,' )'),color='blue')
    setStrokeDecoration('triangle-III-sin')
    step()
    
    displayText(c('cos( ', '\\beta',' )' ),color='green')
    setStrokeDecoration('triangle-III-cos')
    step()
    
    displayText('Add a clone of the first triangle')
    setVisibilty('triangle-II','visible','indefinite')
    step()
    
    displayText('Add a clone of the second triangle')
    setVisibilty('triangle-IV','visible','indefinite')
    step()
    
    displayText('Slide the bottom to the right')
    moveTo('triangle-III', from=c(0,0), to=scalePts(c(cos(alpha) , 0)))
    moveTo('triangle-IV',  from=c(0,0), to=scalePts(c(cos(alpha) , 0)))
    step()
    
    displayText(c('sin( ', '\\alpha',' )'),    color='blue')
    setStrokeDecoration('triangle-I-sin')
    step()
    
    displayText(c('cos( ', '\\beta',' )'),    color='green')
    setStrokeDecoration('triangle-III-cos')
    step()
    
    displayText(  
      c('Area= sin( ','\\alpha',' )', '\\times', 'cos( ', '\\beta',' )'), 
      color='red'
    )
    setStrokeDecoration('triangle-I-sin')
    setStrokeDecoration('triangle-III-cos')
    setVisibilty('sinacosb', 'visible','indefinite')
    step()
    
    displayText(c('cos( ', '\\alpha' ,')'),    color='green')
    setStrokeDecoration('triangle-I-cos')
    step()
    
    displayText(c('sin( ', '\\beta',')'),    color='blue')
    setStrokeDecoration('triangle-IV-sin')
    step()
    
    displayText(  
      c('Area = cos( ', '\\alpha',' )','\\times',' sin( ', '\\beta'," )"
      ), color='blue'
    )
    setStrokeDecoration('triangle-I-cos')
    setStrokeDecoration('triangle-IV-sin')
    setVisibilty("cosasinb", 'visible','indefinite')
    step()
    
    displayText(  
      c('Area= sin(', '\\alpha', ') ', '\\times', ' cos(', '\\beta', ')',
        ' + ', 'cos(', '\\alpha', ') ', '\\times', ' sin(', '\\beta', ')'),
      color='brown'
    )
    setVisibilty("Outer", 'visible','indefinite')
    setVisibilty("sinacosb", 'hidden','indefinite')
    setVisibilty("cosasinb", 'hidden','indefinite')   
    step()
    
    moveTo("triangle-IV",  to=c(0,0), from=scalePts(c(cos(alpha) , 0)))
    step()
    
    setVisibilty('angles','visible','indefinite')
    moveTo("triangle-III",  from=scalePts(c(cos(alpha) , 0)), to=scalePts(c(cos(alpha) , -sin(alpha))))
    step()
    
    moveTo("triangle-I",  from=scalePts(c(0 , 0)), to=scalePts(c(cos(beta) , sin(beta))))
    step()
    
    textArea<-'textArea2'
    setVisibilty('Outer2','visible','indefinite')
    setVisibilty('Outer','hidden','indefinite')
    sapply(paste0("triangle-",c("I","II","III","IV")),
           function(id) setOpacity(id,0.3, dur='indefinite')
    )
    displayText(c('angle', '\\alpha'),color='red')
    setOpacity('alpha-angle',1)
    step()
    
    displayText(c('angle', '\\beta'),color='blue')
    setOpacity('beta-angle',1)
    step()
    
    displayText(c('angle', '\\alpha',' + ','\\beta'),color='black')
    setOpacity('alpha-angle',1, dur="indefinite")
    setOpacity('beta-angle',1, dur="indefinite")
    step()
    
    displayText('Rotate a little')
    rotate('graphAreaR', angles=c(0, -180*beta/pi), 
           about=scalePts(c((cos(alpha)+cos(beta))/2, (sin(alpha)+sin(beta))/2)))
    step()
    
    
    displayText('Drop a perpendicular')
    step(0.5)
    
    setVisibilty('sinAplusB','visible','indefinite')
    step()
    
    displayText('Length=1', color=colors[1])
    setStrokeDecoration('triangle-II-hyp')
    step()
    
    displayText(c('sin( ','\\alpha',' + ','\\beta' ,' )'), color='purple')
    setVisibilty('triangle-V-angle','hidden','indefinite')
    setVisibilty('triangle-V','visible','indefinite')
    setVisibilty('Outer3-2','visible','indefinite')
    setFill('triangle-V','lightyellow')
    setOpacity('triangle-V-interior',0.5,'indefinite')
    setStrokeDecoration('triangle-V-sin', 'indefinite')    
    setVisibilty("Outer2","hidden",'indefinite')
    step()

    setFill('triangle-V','khaki',"indefinite")
    step(0.5)

    
    displayText('But wait..')
    moveTo('triangle-V', from=scalePts(c(0,0)), 
       to=scalePts(c(cos(beta),sin(beta))))    
    step()
    
    setOpacity('triangle-V-interior',1,'indefinite')
    setStroke('triangle-V-hyp','khaki','indefinite')    
    setStroke('triangle-V-cos','red','indefinite')    
    step(.5) 
    
    displayText('Length=1', color=colors[1] )   
    setStrokeDecoration('Outer3-2-upperLeg', 'indefinite')    
    step()
    
    displayText(c('Area= 1 ','\\times','sin( ','\\alpha',' + ','\\beta' ,' )')
                ,'brown')
    setFill('Outer3-2-Poly','yellow')
    setFill('triangle-V-interior','yellow')
    step()
    
    textArea<-'textArea1'
    displayText( 'So' )
    textArea<-'textArea2'    
    displayText(    
      c('sin( ','\\alpha',' + ','\\beta' ,' )',
        ' = sin(', '\\alpha', ') ',  'cos(', '\\beta', ')',
        ' + ', 'cos(', '\\alpha', ') ',  'sin(', '\\beta', ')'),
      'brown'
    )      
  }
  )->tale
  doc
```


### Swinging Balls
to rewrite

### Line Chart
to rewrite

